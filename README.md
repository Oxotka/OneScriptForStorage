# OneScriptForStorage

Создание хранилищ по технологии разветвленной разработки фирмы 1С на OneScript

## Основные проблемы по работе с OneScript

1. Сложно установить на мак. Возможно, даже не стоит
2. Нужно зачем-то выдавать права, чтобы установить библиотеку. Выглядит контринтутивно. Плюс об этом нигде не написано, что это нужно сделать
3. Не понятно как определяется используемая версия платформы. Если тонкий клиент нельзя использовать, зачем его в список версий тогда включать. Шли бы в обратном порядке до нужной платформы и все.
4. Не нашел как указать версию платформы явно. Нужно, например, если используется серверное хранилище с конкретной платформой.
5. Пересекающаяся функциональность v8storage и v8runner про создание хранилищ
6. Еще не написал ни одной строчки кода, а прошло уже 3 дня.

## Шаги и сложности

1. Начал разработку на MacOS (на винде точно проще будет, но пока так попробуем)
2. При начале работы столкнулся с установкой и дополнил основной репозиторий OneScript небольшими советами - https://github.com/EvilBeaver/OneScript/pull/1460
3. Попробовал напрямую вставить использование библиотеки - не получилось
4. Попробовал на маке запустить отладку - не получилось
5. Поменял текст на просто Сообщить("Привет мир"), чтобы проверить как работает - получилось запустить через командную строку типа oscript main.os, как в питоне - сработало
6. Начал разбираться как устанавливать библиотеки. Прочитал про opm, но не знал стоит он у меня или нет. Нашел статью про библиотеки - https://infostart.ru/1c/articles/699642/

В тексте выискал текст команды  opm install yadisk - подумал, вдруг сработает и написать у себя opm install v8storage - Сработало. Удивительно даже :)

7. Попробовал использовать код из библиотеки - работает.
8. Там дальше нужно будет использовать уже конкретную 1Ску, возможно придется переходить на виндовс, но я еще поковыряюсь тут

9. Переключился на Windows.
10. OneScript устанавливается действительно легко и играючи
11. Попытка установить библиотеку работы с хранилищем выдает ошибку:
"{Модуль C:\Program Files\OneScript\lib\opm\src\core\Классы\МенеджерУстановкиПакетов.os / Ошибка в строке: 136 / {Модуль C:\Program Files\OneScript\lib\opm\src\core\Классы\УстановкаПакета.os / Ошибка в строке: 108 / Внешнее исключение (System.UnauthorizedAccessException): Отказано в доступе по пути "C:\Program Files\OneScript\lib\v8storage".}}"

12. Попытался скачать исходники и скопировать их вручную в папку с библиотеками - удалось. Но onescript все равно не видит эту библиотеку. Видимо, нужно где-то ее отдельно прописать - где, непонятно.
13. Пробуем поменять путь установки библиотеки, как описано в opm
set OSCRIPTBIN=c:\temp\ 
opm update -all

В результате ничего не получилось.

14. Выдал права на папку OneScript - Находим в проводнике эту папку. На правую кнопку. Свойства. Закладка Безопасность. Выдаем права. Перезапускаем терминал и пробуем снова.
15. Удалось установить библиотеку.
16. Попытка запуска выдает сообщение - Не задан путь к платформе 1С. Тоже самое было на маке - теперь нужно понять, а как задать этот путь к платформе.
17. Открываем v8runner на ГитХаб и пытаемся найти про путь к платформе. Ничего не найдено.
18. Вот в этом issue - https://github.com/oscript-library/deployka/issues/14 прочитал, что такое может быть если куча разных платформ с тонким клиентом установлено. У меня как раз такой случай, когда используются тонкие клиенты более поздних версий. Значит нужно как-то указать явно нашу версию. Читаем дальше и пытаемся сделать это
19. Начал смотреть код v8runner.os (так как там указываются версии платформы, вернее ищутся) и нашел, что там тоже есть работа с хранилищем. Возможно, библиотека для хранилищ отдельно не нужна и можно использовать встроенную библиотеку из v8runner
20. Код в v8runner ссылается на v8find.os - именно там мы указываем платформу. Идем туда, чтобы посмотреть, где он пытается найти платформу. Сейчас отладчик пустой путь к платформе возвращает
21. Да, по умолчанию он использует самую последнюю версию платформу. А это тонкий клиент, в котором нет конфигуратора. Значит, нам нужно где-то в параметрах создания хранилища или кода указать используюемую версию платформы. Понимаю, что для большинства будет одна последняя платформа и это норм, но стоит, возможно, указывать более детальное сообщение. Потому что сейчас сообщение о том, что не найдена платформа вводит в заблуждение. Не хватает описания, что можно сделать, чтобы починить.
22. Победа! Хоть и костылем. В системном модуле v8runner.os указал вместо платформы 8.3 - платформу 8.3.24
ПутьКПлатформе1С(ПолучитьПутьКВерсииПлатформы("8.3.24", РазрядностьПлатформы.x64x86));
Там сейчас как будто захардкожено. Возможно, стоит это передавать через параметры. Там вон было написано, что используется файл настроек платформы, но у меня почему-то не завелось.
23. Следующий шаг - пытаемся создать хранилище. Явный вызов кода из примера возвращает вот такое сообщение - Модуль C:\Program Files\OneScript\lib\v8runner\src\v8runner.os / Ошибка в строке: 1400 / Создание хранилища конфигурации завершилось с ошибкой.
Стоит, конечно, уделить больше внимания описанию ошибок, так как сейчас они ничего полезного не говорят. Никаких намеков, того что я сделал не так.

24. Пробуем создать хранилище. Подумал, что не задан путь к хранилищу и поэтому нужно его указать. Использовал специальный метод - попробовал выполнить - результат тот же.

25. Решил посмотреть, а что конкретно выполняется - получается, что там запускается в пакетном режиме 1С с командами. Логи пишутся в темп, и когда нужно ЗапуститьИПодождать, то сразу отваливается - почему не понятно
26. Подумал, вдруг проблема в библиотеке, решил заиспользовать петод из v8runner - то же самое в том же месте падает. Оно и понятно, так как это код v8runner
27. Скорее всего проблема либо в правах, либо в пути к 1Ске, так как я явно там указывал какую-то 8.3.24.
28. Подсказали секрет как включить отладку. SET LOGOS_LEVEL=DEBUG в переменных среды. В powershell по-другому - $env:LOGOS_LEVEL="DEBUG", в маке и линуксе вот так - export LOGOS_LEVEL="DEBUG"
Я установил просто в переменные окружения через настройки.
29. Как итог у меня есть отладка в которой как раз показывается весь ключ запуска, который пытается выполнится, но нужно разбираться.
30. Запуск в пакетном режиме просто точно так же ничего не выполняет и ничего не сообщает. Возможно, какие-то команды лишние и их нужно отключить, чтобы посмотреть что к чему.
31. Сама строка запуска вот такая:
"C:\Program Files\1Cv8\8.3.24.1667\bin\1cv8.exe" DESIGNER /F"D:\1\1.txt" /Out "D:\1\2.txt" /WA+ /LRU /VLRU /DisableStartupMessages /DisableStartupDialogs /ConfigurationRepositoryF "D:\1" /ConfigurationRepositoryCreate  -AllowConfigurationChanges -ChangesAllowedRule ObjectNotEditable -ChangesNotRecommendedRule ObjectNotEditable
32. Запуск в терминале сообщил, что "Информационная база не обнаружена!"
33. Поправил строку запуска так:
"C:\Program Files\1Cv8\8.3.24.1667\bin\1cv8.exe" DESIGNER /F"D:\1\1" /Out "D:\1\2.txt" /WA+ /LRU /VLRU /DisableStartupMessages /DisableStartupDialogs /ConfigurationRepositoryF "D:\1" /ConfigurationRepositoryCreate  -AllowConfigurationChanges -ChangesAllowedRule ObjectNotEditable -ChangesNotRecommendedRule ObjectNotEditable
34. Терминал сообщил - Создание хранилища конфигурации завершилось с ошибкой
